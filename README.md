# Fuzz-Against-The-Machine

Fuzz-Against-The-Machine is a simple fuzzer for the MQTT protocol. It is written in Python3 and relies on Scapy to build MQTT control packets.

## Fuzzing concept

This fuzzer utilizes a generation based approach for creating the fuzz.
The following MQTT control packets are supported:

CONNECT
CONNACK
SUBSCRIBE
PUBLISH
PUBACK
PUBREC
PUBREL
PUBCOMP


### Fuzzing
The fuzzing functionality starts by typing 1 in the main menu.
The project contains a file with inputs which are known to cause issues or anomalies in programs. The inputs are ready to use, but can also be altered to fit your needs.
The fuzzer takes the input line by line and inserts it into the specific MQTT control packet fields. For covering all combinations of control packet fields a superset is created. This results in 2^n sent packets per control packet for every input, where n is the number of fields in the MQTT control packet. Additionaly every superset element is sent with one byte cut off at the end until the remaining length is one. Finally for every superset element some bytes are flipped randomly before sending the packet.

For CONNECT, PUBLISH and SUBSCRIBE packets it is possible to predefine fields with custom values by entering them in the specific template file. This enables the user to specify field values that are neccessary to reach inner program logic. One poosible example is the protoname field in the CONNECT packet which must be "MQTT" to generate a valid packet.

The supported MQTT version is 5.
Fuzzing brokers that run on localhost is not supported.

### Delivery

To define the target broker insert IP address and port in the config directory's config.yaml file. Alternate input files can also be defined in the config file.
For delivering the packets Python Sockets are utilized and take care of inserting all TCP related information to send the packet.

### Monitoring

It is recommended to use an addional monitoring tool for detecting problems like memory leaks or buffer overflows, which do not immediately result in crashes.
For C and C++ based brokers the use of ASAN or Valgrind would be a possible choice.

#### ASAN
The following make command can be used to build the sources with ASAN support:

```
make CFLAGS=-fsanitize=address LDFLAGS=-fsanitize=address WITH_DOCS=no
```

The public interface of LeakSanitizer (sanitizer/lsan_interface.h) offers various functions for real time leak detection:


```
__lsan_do_leak_check()
__lsan_do_recoverable_leak_check()
```

### Packet Configurer
An additional feature to send single, predefinded packets. The packets are generated by reading the template file for the specific packet type. Templates can be changed at runtime.
The Packet Configurer starts by entering 2 in the main menu.

## Installation

Fuzz-Against-The-Machine requires the installation of some python modules i n specific versions. To avoid conflicts with existing installations, create a virtual environment to install them:

```bash
virtualenv venv
source venv/bin/activate
pip3 install -r requirements.txt
```

You may need to install virtualenv first by running

```bash
pip3 install virtualenv
```

## Usage

Start the fuzzer:

```
sudo python3 main.py
```




